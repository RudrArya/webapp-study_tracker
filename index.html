<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app" class="p-4 max-w-2xl mx-auto space-y-6"></div>

    <script>
        var state = {
            config: { webhookUrl: '' },
            studyMaterials: {},
            selectedMaterial: '',
            selectedTopic: '',
            manualDate: new Date().toISOString().split('T')[0],
            manualDuration: '',
            manualBreak: '',
            isRunning: false,
            isPaused: false,
            totalTime: 0,
            breakTime: 0,
            sessionStartTime: null,
            pauseStartTime: null,
            loading: false
        };

        var intervalId = null;

        // Check if localStorage is available
        function isLocalStorageAvailable() {
            try {
                var test = '__localStorage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch(e) {
                return false;
            }
        }

        function loadConfig() {
            if (!isLocalStorageAvailable()) {
                console.log('localStorage not available in this environment');
                return;
            }
            
            var saved = localStorage.getItem('studyTrackerConfig');
            if (saved) {
                state.config = JSON.parse(saved);
                if (state.config.webhookUrl) {
                    fetchMaterials(state.config.webhookUrl);
                }
            }
        }

        function saveConfigToStorage() {
            if (isLocalStorageAvailable()) {
                localStorage.setItem('studyTrackerConfig', JSON.stringify(state.config));
            }
        }

        function fetchMaterials(url) {
            state.loading = true;
            render();
            
            console.log('Fetching from:', url + '?action=getMaterials');
            
            // First try with POST and no-cors (for sending the request)
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'getMaterials' })
            }).catch(function(e) {
                console.log('POST request sent');
            });
            
            // Then try GET to read the response
            fetch(url + '?action=getMaterials', {
                method: 'GET'
            })
            .then(function(response) {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.text();
            })
            .then(function(text) {
                console.log('Response text:', text);
                var data = JSON.parse(text);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.materials && Object.keys(data.materials).length > 0) {
                    state.studyMaterials = data.materials;
                    showMessage('Materials loaded successfully!', 'success');
                } else {
                    throw new Error('No materials found in response');
                }
                state.loading = false;
                render();
            })
            .catch(function(error) {
                console.error('Full error:', error);
                showMessage('Failed to fetch materials: ' + error.message, 'error');
                state.loading = false;
                render();
            });
        }

        function sendToSheet(data) {
            if (!state.config.webhookUrl) {
                showMessage('Please configure webhook URL first', 'error');
                return Promise.resolve(false);
            }
            
            return fetch(state.config.webhookUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'addSession', 
                    date: data.date, 
                    material: data.material, 
                    topic: data.topic, 
                    duration: data.duration, 
                    break: data.break, 
                    actualStudyTime: data.actualStudyTime
                })
            })
            .then(function() {
                // With no-cors mode, we can't read the response
                // So we assume success if no error is thrown
                showMessage('Data sent successfully!', 'success');
                return true;
            })
            .catch(function(error) {
                console.error('Error sending data:', error);
                showMessage('Failed to send data: ' + error.message, 'error');
                return false;
            });
        }

        function showMessage(msg, type) {
            var color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
            var msgDiv = document.createElement('div');
            msgDiv.className = 'fixed top-4 right-4 bg-' + color + '-100 border border-' + color + '-300 text-' + color + '-800 px-6 py-3 rounded-lg shadow-lg z-50';
            msgDiv.textContent = msg;
            document.body.appendChild(msgDiv);
            setTimeout(function() { msgDiv.remove(); }, 4000);
        }

        function startStopwatch() {
            state.isRunning = true;
            state.isPaused = false;
            state.sessionStartTime = Date.now();
            state.totalTime = 0;
            state.breakTime = 0;
            state.pauseStartTime = null;
            
            intervalId = setInterval(function() {
                var now = Date.now();
                state.totalTime = now - state.sessionStartTime;
                
                if (state.isPaused && state.pauseStartTime) {
                    state.breakTime += 1000;
                }
                render();
            }, 1000);
            
            render();
        }

        function pauseStopwatch() {
            if (!state.isPaused) {
                state.isPaused = true;
                state.pauseStartTime = Date.now();
            } else {
                state.isPaused = false;
                state.pauseStartTime = null;
            }
            render();
        }

        function stopStopwatch() {
            state.isRunning = false;
            state.isPaused = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            render();
        }

        function formatTime(ms) {
            var seconds = Math.floor(ms / 1000);
            var minutes = Math.floor(seconds / 60);
            var hours = Math.floor(minutes / 60);
            return hours.toString().padStart(2, '0') + ':' + (minutes % 60).toString().padStart(2, '0') + ':' + (seconds % 60).toString().padStart(2, '0');
        }

        function submitStopwatchEntry() {
            if (!state.selectedMaterial || !state.selectedTopic) {
                showMessage('Please select study material and topic', 'error');
                return;
            }
            
            var durationMinutes = state.totalTime / 60000;
            var breakMinutes = state.breakTime / 60000;
            var actualStudyMinutes = (state.totalTime - state.breakTime) / 60000;
            
            var data = {
                date: new Date().toISOString().split('T')[0],
                material: state.selectedMaterial,
                topic: state.selectedTopic,
                duration: Math.round(durationMinutes * 100) / 100,
                break: Math.round(breakMinutes * 100) / 100,
                actualStudyTime: Math.round(actualStudyMinutes * 100) / 100
            };
            
            sendToSheet(data).then(function(success) {
                if (success) {
                    stopStopwatch();
                    state.totalTime = 0;
                    state.breakTime = 0;
                    render();
                }
            });
        }

        function submitManualEntry() {
            if (!state.selectedMaterial || !state.selectedTopic) {
                showMessage('Please select study material and topic', 'error');
                return;
            }
            if (!state.manualDuration) {
                showMessage('Please enter duration', 'error');
                return;
            }
            
            var duration = parseFloat(state.manualDuration);
            var breakDuration = parseFloat(state.manualBreak) || 0;
            var actualStudyTime = duration - breakDuration;
            
            var data = {
                date: state.manualDate,
                material: state.selectedMaterial,
                topic: state.selectedTopic,
                duration: duration,
                break: breakDuration,
                actualStudyTime: actualStudyTime
            };
            
            sendToSheet(data).then(function(success) {
                if (success) {
                    state.manualDuration = '';
                    state.manualBreak = '';
                    render();
                }
            });
        }

        function saveConfig() {
            if (!state.config.webhookUrl) {
                showMessage('Please enter a webhook URL', 'error');
                return;
            }
            saveConfigToStorage();
            fetchMaterials(state.config.webhookUrl);
        }

        function render() {
            var studyTime = state.totalTime - state.breakTime;
            var availableTopics = state.selectedMaterial && state.studyMaterials[state.selectedMaterial] 
                ? state.studyMaterials[state.selectedMaterial] : [];
            
            // Save scroll position
            var scrollPos = window.pageYOffset || document.documentElement.scrollTop;
            
            var html = '';
            
            html += '<div class="bg-white rounded-xl shadow-lg p-6">';
            html += '<h1 class="text-3xl font-bold text-indigo-900 flex items-center gap-2">';
            html += 'üìö Study Tracker';
            html += '</h1>';
            html += '<p class="text-gray-600 mt-2">Track your study sessions and streaks</p>';
            if (!isLocalStorageAvailable()) {
                html += '<p class="text-xs text-orange-600 mt-2">‚ö†Ô∏è localStorage not available - settings won\'t persist</p>';
            }
            html += '</div>';
            
            html += '<div class="bg-white rounded-xl shadow-lg p-6">';
            html += '<div class="flex items-center justify-between mb-4">';
            html += '<h2 class="text-lg font-semibold text-gray-800">‚öôÔ∏è Configuration</h2>';
            if (state.config.webhookUrl) {
                html += '<button onclick="fetchMaterials(\'' + state.config.webhookUrl.replace(/'/g, "\\'") + '\')" ';
                html += (state.loading ? 'disabled' : '');
                html += ' class="flex items-center gap-2 px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg text-sm hover:bg-indigo-200 transition disabled:opacity-50">';
                html += 'üîÑ Refresh';
                html += '</button>';
            }
            html += '</div>';
            html += '<div class="space-y-4">';
            html += '<div>';
            html += '<label class="block text-sm font-medium text-gray-700 mb-2">Google Sheet Webhook URL</label>';
            html += '<input type="text" value="' + state.config.webhookUrl + '" oninput="state.config.webhookUrl = this.value" placeholder="https://script.google.com/macros/s/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />';
            html += '<p class="text-xs text-gray-500 mt-1">Used for both sending data and fetching materials</p>';
            html += '</div>';
            html += '<button onclick="saveConfig()" ' + (state.loading ? 'disabled' : '') + ' class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition disabled:opacity-50">';
            html += (state.loading ? 'Loading...' : 'Save & Load Materials');
            html += '</button>';
            html += '</div>';
            
            if (Object.keys(state.studyMaterials).length > 0) {
                html += '<div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">';
                html += '<p class="text-sm text-green-800 font-medium">‚úì Loaded ' + Object.keys(state.studyMaterials).length + ' study materials</p>';
                html += '<p class="text-xs text-green-600 mt-1">' + Object.keys(state.studyMaterials).join(', ') + '</p>';
                html += '</div>';
            }
            html += '</div>';
            
            html += '<div class="bg-white rounded-xl shadow-lg p-6">';
            html += '<h2 class="text-xl font-semibold text-gray-800 mb-4">Study Selection</h2>';
            
            if (Object.keys(state.studyMaterials).length === 0) {
                html += '<div class="text-center py-8 text-gray-500">';
                html += '<p>‚ö†Ô∏è Please configure webhook URL and load materials first</p>';
                html += '</div>';
            } else {
                html += '<div class="space-y-4">';
                html += '<div>';
                html += '<label class="block text-sm font-medium text-gray-700 mb-2">1. Study Material (Main Category)</label>';
                html += '<select onchange="state.selectedMaterial = this.value; state.selectedTopic = \'\'; render();" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base">';
                html += '<option value="">-- Select Study Material --</option>';
                for (var material in state.studyMaterials) {
                    html += '<option value="' + material + '" ' + (state.selectedMaterial === material ? 'selected' : '') + '>' + material + '</option>';
                }
                html += '</select>';
                html += '</div>';
                
                if (state.selectedMaterial) {
                    html += '<div>';
                    html += '<label class="block text-sm font-medium text-gray-700 mb-2">2. Topic (Filtered by ' + state.selectedMaterial + ')</label>';
                    html += '<select onchange="state.selectedTopic = this.value; render();" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base">';
                    html += '<option value="">-- Select Topic --</option>';
                    for (var i = 0; i < availableTopics.length; i++) {
                        html += '<option value="' + availableTopics[i] + '" ' + (state.selectedTopic === availableTopics[i] ? 'selected' : '') + '>' + availableTopics[i] + '</option>';
                    }
                    html += '</select>';
                    if (availableTopics.length === 0) {
                        html += '<p class="text-xs text-red-600 mt-1">No topics available for this material</p>';
                    }
                    html += '</div>';
                }
                
                if (state.selectedMaterial && state.selectedTopic) {
                    html += '<div class="bg-indigo-50 rounded-lg p-4 border-2 border-indigo-200">';
                    html += '<p class="font-medium text-indigo-900 text-center">üìö ' + state.selectedMaterial + ' ‚Üí ' + state.selectedTopic + '</p>';
                    html += '</div>';
                }
                html += '</div>';
            }
            html += '</div>';
            
            html += '<div class="bg-white rounded-xl shadow-lg p-6">';
            html += '<h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">‚è±Ô∏è Stopwatch Mode</h2>';
            html += '<div class="text-center space-y-6">';
            html += '<div class="bg-indigo-50 rounded-lg p-6">';
            html += '<div class="text-5xl font-mono font-bold text-indigo-900 mb-2">' + formatTime(state.totalTime) + '</div>';
            html += '<div class="text-sm text-gray-600">Total Duration</div>';
            html += '</div>';
            
            html += '<div class="grid grid-cols-2 gap-4">';
            html += '<div class="bg-green-50 rounded-lg p-4">';
            html += '<div class="text-2xl font-mono font-semibold text-green-700">' + formatTime(studyTime) + '</div>';
            html += '<div class="text-xs text-gray-600">Study Time</div>';
            html += '</div>';
            html += '<div class="bg-orange-50 rounded-lg p-4">';
            html += '<div class="text-2xl font-mono font-semibold text-orange-700">' + formatTime(state.breakTime) + '</div>';
            html += '<div class="text-xs text-gray-600 flex items-center justify-center gap-1">‚òï Break Time</div>';
            html += '</div>';
            html += '</div>';
            
            if (state.isPaused) {
                html += '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">';
                html += '<p class="text-yellow-800 text-sm font-medium">‚è∏Ô∏è Break Time Running</p>';
                html += '</div>';
            }
            
            html += '<div class="flex gap-3">';
            if (!state.isRunning) {
                html += '<button onclick="startStopwatch()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 transition flex items-center justify-center gap-2">‚ñ∂Ô∏è Start</button>';
            } else {
                html += '<button onclick="pauseStopwatch()" class="flex-1 ' + (state.isPaused ? 'bg-blue-600 hover:bg-blue-700' : 'bg-yellow-600 hover:bg-yellow-700') + ' text-white py-3 rounded-lg font-medium transition flex items-center justify-center gap-2">';
                html += (state.isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Break');
                html += '</button>';
                html += '<button onclick="stopStopwatch()" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-medium hover:bg-red-700 transition flex items-center justify-center gap-2">‚èπÔ∏è Stop</button>';
            }
            html += '</div>';
            
            if (!state.isRunning && state.totalTime > 0) {
                html += '<button onclick="submitStopwatchEntry()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition flex items-center justify-center gap-2">üì§ Send to Sheet</button>';
            }
            html += '</div>';
            html += '</div>';
            
            html += '<div class="bg-white rounded-xl shadow-lg p-6">';
            html += '<h2 class="text-xl font-semibold text-gray-800 mb-4">Manual Entry</h2>';
            html += '<div class="space-y-4">';
            html += '<div>';
            html += '<label class="block text-sm font-medium text-gray-700 mb-2">Date</label>';
            html += '<input type="date" value="' + state.manualDate + '" onchange="state.manualDate = this.value" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />';
            html += '</div>';
            html += '<div>';
            html += '<label class="block text-sm font-medium text-gray-700 mb-2">Duration (minutes)</label>';
            html += '<input type="number" value="' + state.manualDuration + '" oninput="state.manualDuration = this.value" placeholder="60" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />';
            html += '</div>';
            html += '<div>';
            html += '<label class="block text-sm font-medium text-gray-700 mb-2">Break (minutes)</label>';
            html += '<input type="number" value="' + state.manualBreak + '" oninput="state.manualBreak = this.value" placeholder="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />';
            html += '</div>';
            
            if (state.manualDuration) {
                html += '<div class="bg-blue-50 rounded-lg p-4">';
                html += '<div class="text-sm text-gray-600">Actual Study Time</div>';
                html += '<div class="text-2xl font-semibold text-blue-700">' + (parseFloat(state.manualDuration) - (parseFloat(state.manualBreak) || 0)).toFixed(1) + ' minutes</div>';
                html += '</div>';
            }
            
            html += '<button onclick="submitManualEntry()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition flex items-center justify-center gap-2">üì§ Send to Sheet</button>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('app').innerHTML = html;
            
            // Restore scroll position
            window.scrollTo(0, scrollPos);
        }

        loadConfig();
        render();
    </script>
</body>
</html>